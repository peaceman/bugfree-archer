/*! ng-flow 1.0.0-beta3 */
!function(a,b){"use strict";function c(b){if(this.support=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof FileList||!Blob.prototype.slice&&!Blob.prototype.webkitSlice&&!Blob.prototype.mozSlice),this.support){this.supportDirectory=/WebKit/.test(a.navigator.userAgent),this.files=[],this.defaults={chunkSize:1048576,forceChunkSize:!1,simultaneousUploads:3,singleFile:!1,fileParameterName:"file",progressCallbacksInterval:500,speedSmoothingFactor:.1,query:{},headers:{},withCredentials:!1,preprocess:null,method:"multipart",prioritizeFirstAndLastChunk:!1,target:"/",testChunks:!0,generateUniqueIdentifier:null,maxChunkRetries:0,chunkRetryInterval:null,permanentErrors:[404,415,500,501]},this.opts={},this.events=[];var d=this;this.onDrop=function(a){a.stopPropagation(),a.preventDefault();var b=a.dataTransfer;b.items&&b.items[0]&&b.items[0].webkitGetAsEntry?d.webkitReadDataTransfer(a):d.addFiles(b.files,a)},this.preventEvent=function(a){a.preventDefault()},this.opts=c.extend({},this.defaults,b||{})}}function d(a,b){this.flowObj=a,this.file=b,this.name=b.fileName||b.name,this.size=b.size,this.relativePath=b.relativePath||b.webkitRelativePath||this.name,this.uniqueIdentifier=a.generateUniqueIdentifier(b),this.chunks=[],this.paused=!1,this.error=!1,this.averageSpeed=0,this.currentSpeed=0,this._lastProgressCallback=Date.now(),this._prevUploadedSize=0,this._prevProgress=0,this.bootstrap()}function e(a,b,c){this.flowObj=a,this.fileObj=b,this.fileObjSize=b.size,this.offset=c,this.tested=!1,this.retries=0,this.pendingRetry=!1,this.preprocessState=0,this.loaded=0,this.total=0;var d=this.flowObj.opts.chunkSize;this.startByte=this.offset*d,this.endByte=Math.min(this.fileObjSize,(this.offset+1)*d),this.xhr=null,this.fileObjSize-this.endByte<d&&!this.flowObj.opts.forceChunkSize&&(this.endByte=this.fileObjSize);var e=this;this.progressHandler=function(a){a.lengthComputable&&(e.loaded=a.loaded,e.total=a.total),e.fileObj.chunkEvent("progress")},this.testHandler=function(){var a=e.status();"success"===a?(e.tested=!0,e.fileObj.chunkEvent(a,e.message()),e.flowObj.uploadNextChunk()):e.fileObj.paused||(e.tested=!0,e.send())},this.doneHandler=function(){var a=e.status();if("success"===a||"error"===a)e.fileObj.chunkEvent(a,e.message()),e.flowObj.uploadNextChunk();else{e.fileObj.chunkEvent("retry",e.message()),e.pendingRetry=!0,e.abort(),e.retries++;var b=e.flowObj.opts.chunkRetryInterval;null!==b?setTimeout(function(){e.send()},b):e.send()}}}function f(a){return g(arguments,function(b){b!==a&&g(b,function(b,c){a[c]=b})}),a}function g(a,b,c){if(a){var d;if("undefined"!=typeof a.length){for(d=0;d<a.length;d++)if(b.call(c,a[d],d)===!1)return}else for(d in a)if(a.hasOwnProperty(d)&&b.call(c,a[d],d)===!1)return}}c.prototype={on:function(a,b){this.events.push(a.toLowerCase(),b)},fire:function(a,b){b=Array.prototype.slice.call(arguments),a=a.toLowerCase();for(var c=!1,d=0;d<=this.events.length;d+=2)this.events[d]===a&&(c=this.events[d+1].apply(this,b.slice(1))===!1||c),"catchall"===this.events[d]&&(c=this.events[d+1].apply(null,b)===!1||c);return!c},webkitReadDataTransfer:function(a){function b(a){h+=a.length,g(a,function(a){if(a.isFile){var e=a.fullPath;a.file(function(a){c(a,e)},d)}else a.isDirectory&&a.createReader().readEntries(b,d)}),e()}function c(a,b){a.relativePath=b.substring(1),i.push(a),e()}function d(a){throw a}function e(){0==--h&&f.addFiles(i,a)}var f=this,h=a.dataTransfer.items.length,i=[];g(a.dataTransfer.items,function(a){var f=a.webkitGetAsEntry();return f?(f.isFile?c(a.getAsFile(),f.fullPath):f.createReader().readEntries(b,d),void 0):(e(),void 0)})},generateUniqueIdentifier:function(a){var b=this.opts.generateUniqueIdentifier;if("function"==typeof b)return b(a);var c=a.relativePath||a.webkitRelativePath||a.fileName||a.name;return a.size+"-"+c.replace(/[^0-9a-zA-Z_-]/gim,"")},uploadNextChunk:function(a){var b=!1;if(this.opts.prioritizeFirstAndLastChunk&&(g(this.files,function(a){return!a.paused&&a.chunks.length&&"pending"===a.chunks[0].status()&&0===a.chunks[0].preprocessState?(a.chunks[0].send(),b=!0,!1):!a.paused&&a.chunks.length>1&&"pending"===a.chunks[a.chunks.length-1].status()&&0===a.chunks[0].preprocessState?(a.chunks[a.chunks.length-1].send(),b=!0,!1):void 0}),b))return b;if(g(this.files,function(a){return a.paused||g(a.chunks,function(a){return"pending"===a.status()&&0===a.preprocessState?(a.send(),b=!0,!1):void 0}),b?!1:void 0}),b)return!0;var c=!1;return g(this.files,function(a){return a.isComplete()?void 0:(c=!0,!1)}),c||a||this.fire("complete"),!1},assignBrowse:function(a,c,d){"undefined"==typeof a.length&&(a=[a]),g(a,function(a){var e;"INPUT"===a.tagName&&"file"===a.type?e=a:(e=b.createElement("input"),e.setAttribute("type","file"),f(a.style,{display:"inline-block",position:"relative",overflow:"hidden",verticalAlign:"top"}),f(e.style,{position:"absolute",top:0,right:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,opacity:0,cursor:"pointer"}),a.appendChild(e)),this.opts.singleFile||d||e.setAttribute("multiple","multiple"),c&&e.setAttribute("webkitdirectory","webkitdirectory");var g=this;e.addEventListener("change",function(a){g.addFiles(a.target.files,a),a.target.value=""},!1)},this)},assignDrop:function(a){"undefined"==typeof a.length&&(a=[a]),g(a,function(a){a.addEventListener("dragover",this.preventEvent,!1),a.addEventListener("dragenter",this.preventEvent,!1),a.addEventListener("drop",this.onDrop,!1)},this)},unAssignDrop:function(a){"undefined"==typeof a.length&&(a=[a]),g(a,function(a){a.removeEventListener("dragover",this.preventEvent),a.removeEventListener("dragenter",this.preventEvent),a.removeEventListener("drop",this.onDrop)},this)},isUploading:function(){var a=!1;return g(this.files,function(b){return b.isUploading()?(a=!0,!1):void 0}),a},upload:function(){if(!this.isUploading()){this.fire("uploadStart");for(var a=!1,b=1;b<=this.opts.simultaneousUploads;b++)a=this.uploadNextChunk(!0)||a;a||this.fire("complete")}},resume:function(){g(this.files,function(a){a.resume()})},pause:function(){g(this.files,function(a){a.pause()})},cancel:function(){for(var a=this.files.length-1;a>=0;a--)this.files[a].cancel()},progress:function(){var a=0,b=0;return g(this.files,function(c){a+=c.progress()*c.size,b+=c.size}),b>0?a/b:0},addFile:function(a,b){this.addFiles([a],b)},addFiles:function(a,b){var c=[];g(a,function(a){if((a.size%4096!==0||"."!==a.name&&"."!==a.fileName)&&!this.getFromUniqueIdentifier(this.generateUniqueIdentifier(a))){var e=new d(this,a);this.fire("fileAdded",e,b)&&c.push(e)}},this),this.fire("filesAdded",c,b)&&g(c,function(a){this.opts.singleFile&&this.files.length>0&&this.removeFile(this.files[0]),this.files.push(a)},this),this.fire("filesSubmitted",c,b)},removeFile:function(a){for(var b=this.files.length-1;b>=0;b--)this.files[b]===a&&(this.files.splice(b,1),a.abort())},getFromUniqueIdentifier:function(a){var b=!1;return g(this.files,function(c){c.uniqueIdentifier===a&&(b=c)}),b},getSize:function(){var a=0;return g(this.files,function(b){a+=b.size}),a},sizeUploaded:function(){var a=0;return g(this.files,function(b){a+=b.sizeUploaded()}),a},timeRemaining:function(){var a=0,b=0;return g(this.files,function(c){c.paused||c.error||(a+=c.size-c.sizeUploaded(),b+=c.averageSpeed)}),a&&!b?Number.POSITIVE_INFINITY:a||b?Math.floor(a/b):0}},d.prototype={measureSpeed:function(){var a=Date.now()-this._lastProgressCallback;if(a){var b=this.flowObj.opts.speedSmoothingFactor,c=this.sizeUploaded();this.currentSpeed=Math.max((c-this._prevUploadedSize)/a*1e3,0),this.averageSpeed=b*this.currentSpeed+(1-b)*this.averageSpeed,this._prevUploadedSize=c}},chunkEvent:function(a,b){switch(a){case"progress":if(Date.now()-this._lastProgressCallback<this.flowObj.opts.progressCallbacksInterval)break;this.measureSpeed(),this.flowObj.fire("fileProgress",this),this.flowObj.fire("progress"),this._lastProgressCallback=Date.now();break;case"error":this.error=!0,this.abort(!0),this.flowObj.fire("fileError",this,b),this.flowObj.fire("error",b,this);break;case"success":if(this.error)return;this.measureSpeed(),this.flowObj.fire("fileProgress",this),this.flowObj.fire("progress"),this._lastProgressCallback=Date.now(),this.isComplete()&&(this.currentSpeed=0,this.averageSpeed=0,this.flowObj.fire("fileSuccess",this,b));break;case"retry":this.flowObj.fire("fileRetry",this)}},pause:function(){this.paused=!0,this.abort()},resume:function(){this.paused=!1,this.flowObj.upload()},abort:function(a){this.currentSpeed=0,this.averageSpeed=0;var b=this.chunks;a&&(this.chunks=[]),g(b,function(a){"uploading"===a.status()&&(a.abort(),this.flowObj.uploadNextChunk())},this)},cancel:function(){this.flowObj.removeFile(this)},retry:function(){this.bootstrap(),this.flowObj.upload()},bootstrap:function(){this.abort(!0),this.error=!1,this._prevProgress=0;for(var a=this.flowObj.opts.forceChunkSize?Math.ceil:Math.floor,b=Math.max(a(this.file.size/this.flowObj.opts.chunkSize),1),c=0;b>c;c++)this.chunks.push(new e(this.flowObj,this,c))},progress:function(){if(this.error)return 1;if(1===this.chunks.length)return this._prevProgress=Math.max(this._prevProgress,this.chunks[0].progress()),this._prevProgress;var a=0;g(this.chunks,function(b){a+=b.progress()*(b.endByte-b.startByte)});var b=a/this.size;return this._prevProgress=Math.max(this._prevProgress,b>.999?1:b),this._prevProgress},isUploading:function(){var a=!1;return g(this.chunks,function(b){return"uploading"===b.status()?(a=!0,!1):void 0}),a},isComplete:function(){var a=!1;return g(this.chunks,function(b){var c=b.status();return"pending"===c||"uploading"===c||1===b.preprocessState?(a=!0,!1):void 0}),!a},sizeUploaded:function(){var a=0;return g(this.chunks,function(b){a+=b.sizeUploaded()}),a},timeRemaining:function(){if(this.paused||this.error)return 0;var a=this.size-this.sizeUploaded();return a&&!this.averageSpeed?Number.POSITIVE_INFINITY:a||this.averageSpeed?Math.floor(a/this.averageSpeed):0},getType:function(){return this.file.type&&this.file.type.split("/")[1]},getExtension:function(){return this.name.substr((~-this.name.lastIndexOf(".")>>>0)+2).toLowerCase()}},e.prototype={getParams:function(){return{flowChunkNumber:this.offset+1,flowChunkSize:this.flowObj.opts.chunkSize,flowCurrentChunkSize:this.endByte-this.startByte,flowTotalSize:this.fileObjSize,flowIdentifier:this.fileObj.uniqueIdentifier,flowFilename:this.fileObj.name,flowRelativePath:this.fileObj.relativePath,flowTotalChunks:this.fileObj.chunks.length}},getTarget:function(a){var b=this.flowObj.opts.target;return b+=b.indexOf("?")<0?"?":"&",b+a.join("&")},test:function(){this.xhr=new XMLHttpRequest,this.xhr.addEventListener("load",this.testHandler,!1),this.xhr.addEventListener("error",this.testHandler,!1);var a=this.prepareXhrRequest("GET");this.xhr.send(a)},preprocessFinished:function(){this.preprocessState=2,this.send()},send:function(){var a=this.flowObj.opts.preprocess;if("function"==typeof a)switch(this.preprocessState){case 0:return a(this),this.preprocessState=1,void 0;case 1:return;case 2:}if(this.flowObj.opts.testChunks&&!this.tested)return this.test(),void 0;this.loaded=0,this.total=0,this.pendingRetry=!1;var b=this.fileObj.file.slice?"slice":this.fileObj.file.mozSlice?"mozSlice":this.fileObj.file.webkitSlice?"webkitSlice":"slice",c=this.fileObj.file[b](this.startByte,this.endByte);this.xhr=new XMLHttpRequest,this.xhr.upload.addEventListener("progress",this.progressHandler,!1),this.xhr.addEventListener("load",this.doneHandler,!1),this.xhr.addEventListener("error",this.doneHandler,!1);var d=this.prepareXhrRequest("POST",this.flowObj.opts.method,c);this.xhr.send(d)},abort:function(){var a=this.xhr;this.xhr=null,a&&a.abort()},status:function(){return this.pendingRetry?"uploading":this.xhr?this.xhr.readyState<4?"uploading":200==this.xhr.status?"success":this.flowObj.opts.permanentErrors.indexOf(this.xhr.status)>-1||this.retries>=this.flowObj.opts.maxChunkRetries?"error":(this.abort(),"pending"):"pending"},message:function(){return this.xhr?this.xhr.responseText:""},progress:function(){if(this.pendingRetry)return 0;var a=this.status();return"success"===a||"error"===a?1:"pending"===a?0:this.total>0?this.loaded/this.total:0},sizeUploaded:function(){var a=this.endByte-this.startByte;return"success"!==this.status()&&(a=this.progress()*a),a},prepareXhrRequest:function(a,b,c){var d=this.flowObj.opts.query;"function"==typeof d&&(d=d(this.fileObj,this)),d=f(this.getParams(),d);var e=this.flowObj.opts.target,h=null;if("GET"===a||"octet"===b){var i=[];g(d,function(a,b){i.push([encodeURIComponent(b),encodeURIComponent(a)].join("="))}),e=this.getTarget(i),h=c||null}else h=new FormData,g(d,function(a,b){h.append(b,a)}),h.append(this.flowObj.opts.fileParameterName,c);return this.xhr.open(a,e),this.xhr.withCredentials=this.flowObj.opts.withCredentials,g(this.flowObj.opts.headers,function(a,b){this.xhr.setRequestHeader(b,a)},this),h}},c.extend=f,c.each=g,c.FlowFile=d,c.FlowChunk=e,c.version="2.0.0","undefined"!=typeof module?module.exports=c:"function"==typeof define&&define.amd?define(function(){return c}):a.Flow=c}(window,document),angular.module("ngFlow.provider",[]).provider("flowFactory",function(){"use strict";this.defaults={},this.factory=function(a){return new Flow(a)},this.events=[],this.on=function(a,b){this.events.push([a,b])},this.$get=function(){var a=this.factory,b=this.defaults,c=this.events;return{create:function(d){var e=a(angular.extend({},b,d));return angular.forEach(c,function(a){e.on(a[0],a[1])}),e}}}}),angular.module("ngFlow.init",["ngFlow.provider"]).controller("NgFlowCtrl",["$scope","$attrs","$parse","flowFactory",function(a,b,c,d){function e(a){return a.charAt(0).toUpperCase()+a.slice(1)}var f=angular.extend({},a.$eval(b.ngFlowInit)),g=d.create(f),h={fileSuccess:["$file","$message"],fileProgress:["$file"],fileAdded:["$file","$event"],filesAdded:["$files","$event"],filesSubmitted:["$files","$event"],fileRetry:["$file"],fileError:["$file","$message"],uploadStart:[],complete:[],progress:[],error:["$message","$file"]};angular.forEach(h,function(d,f){var h="ng"+e(f);if(b.hasOwnProperty(h)){var i=c(b[h]);g.on(f,function(){var b=arguments,c={};return angular.forEach(d,function(a,d){c[a]=b[d]}),i(a,c)})}}),g.on("catchAll",function(b){({progress:1,filesSubmitted:1,fileSuccess:1,fileError:1})[b]&&a.$apply()}),a.$flow=g}]).directive("ngFlowInit",[function(){return{scope:!0,controller:"NgFlowCtrl"}}]),angular.module("ngFlow.btn",["ngFlow.init"]).directive("ngFlowBtn",[function(){return{restrict:"EA",scope:!1,require:"^ngFlowInit",link:function(a,b,c){var d=c.hasOwnProperty("ngDirectory"),e=c.hasOwnProperty("ngSingleFile");a.$flow.assignBrowse(b,d,e)}}}]),angular.module("ngFlow.drop",["ngFlow.init"]).directive("ngFlowDrop",["$timeout",function(a){return{scope:!1,require:"^ngFlowInit",link:function(b,c,d){function e(a){var b=!1,c=a.dataTransfer||a.originalEvent.dataTransfer;return angular.forEach(c&&c.types,function(a){"Files"===a&&(b=!0)}),b}b.$flow.assignDrop(c);var f=d.ngDragOverClass;if(f){var g;c.bind("dragover",function(b){e(b)&&(c.addClass(f),a.cancel(g),g=a(function(){c.removeClass(f)},100,!1),b.preventDefault())})}}}}]),angular.module("ngFlow.img",["ngFlow.init"]).directive("ngFlowImg",[function(){return{scope:!1,require:"^ngFlowInit",link:function(a,b,c){var d=c.ngFlowImg;a.$watch(d,function(b){if(b){var d=new FileReader;d.readAsDataURL(b.file),d.onload=function(b){a.$apply(function(){c.$set("src",b.target.result)})}}})}}}]),angular.module("ngFlow.transfers",["ngFlow.init"]).directive("ngFlowTransfers",[function(){return{scope:!0,require:"^ngFlowInit",link:function(a){a.transfers=a.$flow.files}}}]),angular.module("ngFlow",["ngFlow.provider","ngFlow.init","ngFlow.btn","ngFlow.drop","ngFlow.transfers","ngFlow.img"]);